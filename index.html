<!-- index.html (Client-side PWA + Device-bound unlock) -->
<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BG РЕСТО</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="manifest" href="manifest.json"> 
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#158062">
    <meta name="application-name" content="BG РЕСТО">
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; display:flex; justify-content:center; align-items:center; }
        .app-container { background-color:white; width:100%; max-width:375px; height:100%; display:flex; flex-direction:column; }
        /* ... останалите стилове от твоя файл ... */
    </style>
</head>
<body onload="loadCashLimits(); checkProStatus();">

<div class="app-container">
    <div class="content" id="lockedContent">
        <div class="instruction">Въведи сметката и сумата,<br> с която е платено</div>

        <input type="number" id="billEur" placeholder="Сметка в евро" step="0.01">
        <input type="number" id="paidEur" placeholder="Платено в евро" step="0.01">
        <input type="number" id="paidBgn" placeholder="Платено в лв" step="0.01">

        <button class="btn-calc" onclick="calculateResto()">ИЗЧИСЛИ РЕСТО</button>

        <div class="results">
            <p>Връщаш €: <span id="resEur">0.00</span></p>
            <p>Връщаш лв: <span id="resBgn">0.00</span></p>
            <p class="total-bill">Обща сметка: <span id="totalBillDisplay">0.00</span> лв</p>
            <p class="warning" id="cashWarning"></p>
        </div>

        <div class="cash-section">
            <h3>Наличност в евро (за оптимизация)</h3>
            <input type="number" id="cashEur" placeholder="0 ако нямаш евро" step="0.01" oninput="saveCashLimit()">
        </div>

        <button class="btn-calc-pink" onclick="calculateResto()">ИЗЧИСЛИ РЕСТО</button>
        <button class="btn-reset" onclick="resetFields()">НУЛИРАНЕ</button>
    </div>

    <div class="full-lock-overlay" id="fullLockOverlay" style="display:none;">
        <div class="lock-content">
            <p style="font-size:20px;font-weight:bold;color:#158062;">ПРИЛОЖЕНИЕТО Е ЗАКЛЮЧЕНО</p>
            <input type="text" id="unlockKey" placeholder="ВЪВЕДЕТЕ ВАШИЯ КОД">
            <button class="btn-calc" id="confirmUnlockBtn">ПОТВЪРДИ КЛЮЧ</button>
        </div>
    </div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzEVc1FWkjDkIBmBUs6ubp09bFD48vyRB6zlOshR3bJhqU3VP6pfyb7flOdqwPEHSKc/exec";
const LS_UNLOCKED_STATUS = 'isProUnlocked_AppsScript';
const EURO_RATE = 1.95583;

document.getElementById('confirmUnlockBtn').addEventListener('click', unlockFeatureWithKey);

function roundMoney(amount) {
    return Math.round((amount + Number.EPSILON) * 100) / 100;
}

function getOrCreateUUID() {
    let uuid = localStorage.getItem('deviceUUID');
    if (!uuid) {
        uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        localStorage.setItem('deviceUUID', uuid);
    }
    return uuid;
}

async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
    const hashArray = [...new Uint8Array(hashBuffer)];
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function getDeviceIDFromKey(unlockKey) {
    return await sha256(unlockKey);
}

function checkProStatus() {
    const unlocked = localStorage.getItem(LS_UNLOCKED_STATUS) === 'true';
    document.getElementById('fullLockOverlay').style.display = unlocked ? 'none' : 'flex';
    document.getElementById('lockedContent').style.opacity = unlocked ? '1' : '0';
    document.getElementById('lockedContent').style.pointerEvents = unlocked ? 'auto' : 'none';
}

async function unlockFeatureWithKey() {
    const unlockKey = document.getElementById('unlockKey').value.trim();
    if (!unlockKey) return alert("Въведете код");

    const deviceHash = await getDeviceIDFromKey(unlockKey);
    const url = `${API_ENDPOINT}?action=activate&key=${encodeURIComponent(unlockKey)}&device=${deviceHash}`;

    try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.status === 'success') {
            localStorage.setItem(LS_UNLOCKED_STATUS, 'true');
            alert("Успех! Отключено.");
        } else {
            alert(data.message || "Грешка");
        }
    } catch (e) {
        alert("Грешка при свързване със сървъра");
    }

    document.getElementById('unlockKey').value = '';
    checkProStatus();
}

function saveCashLimit() {
    if (localStorage.getItem(LS_UNLOCKED_STATUS) === 'true') {
        localStorage.setItem('resto_cashEur', document.getElementById('cashEur').value);
    }
}

function loadCashLimits() {
    document.getElementById('cashEur').value = localStorage.getItem('resto_cashEur') || '';
}

function calculateResto() {
    if (localStorage.getItem(LS_UNLOCKED_STATUS) !== 'true') return alert("Заключено е!");

    let bill = parseFloat(document.getElementById('billEur').value) || 0;
    let paidEur = parseFloat(document.getElementById('paidEur').value) || 0;
    let paidBgn = parseFloat(document.getElementById('paidBgn').value) || 0;
    let cashEur = parseFloat(document.getElementById('cashEur').value) || Infinity;

    let billLeva = bill * EURO_RATE;
    let paidLeva = paidEur * EURO_RATE + paidBgn;
    let change = roundMoney(paidLeva - billLeva);

    document.getElementById('totalBillDisplay').innerText = billLeva.toFixed(2);

    if (change < 0) {
        document.getElementById('resEur').innerText = "Недостиг!";
        document.getElementById('resBgn').innerText = Math.abs(change).toFixed(2);
        return;
    }

    let changeEur = roundMoney(change / EURO_RATE);
    let returnEur = Math.min(changeEur, cashEur);
    let returnBgn = roundMoney(change - returnEur * EURO_RATE);

    document.getElementById('resEur').innerText = returnEur.toFixed(2);
    document.getElementById('resBgn').innerText = returnBgn.toFixed(2);
}

function resetFields() {
    if (localStorage.getItem(LS_UNLOCKED_STATUS) !== 'true') return;
    document.getElementById('billEur').value = '';
    document.getElementById('paidEur').value = '';
    document.getElementById('paidBgn').value = '';
    document.getElementById('resEur').innerText = '0.00';
    document.getElementById('resBgn').innerText = '0.00';
    document.getElementById('totalBillDisplay').innerText = '0.00';
}
</script>

</body>
</html>
